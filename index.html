<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Voxels Wearables Explorer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/favicon.ico" />
    <link
      rel="preload"
      href="./rubik.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous"
    />
    <script src="./db.js"></script>
    <script
      type="module"
      src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-window@1.8.10/dist/index-prod.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.5/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <style>
      @font-face {
        /* latin */
        font-family: "Rubik";
        font-style: normal;
        font-weight: 300 900;
        font-display: swap;
        src: url(/rubik.woff2) format("woff2");
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6,
          U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC,
          U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }
      * {
        min-width: 0;
      }
      html,
      body {
        box-sizing: border-box;
        -webkit-font-smoothing: antialiased;
        font-family: "Rubik", sans-serif;
        font-optical-sizing: auto;
        font-size: 16px;
        font-weight: 400;
        font-style: normal;
      }
      input,
      textarea {
        border: 0;
        background: none;
        outline: 0;
        padding: 0;
        margin: 0;
        display: block;
        width: 100%;
        font-family: inherit;
        font-size: inherit;
        color: inherit;
      }
      input::placeholder,
      textarea::placeholder {
        color: #bebebe;
      }
      a {
        text-decoration: none;
        color: inherit;
      }
      img {
        max-width: 100%;
        height: auto;
      }
      .appd {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 100vh;
        height: -webkit-fill-available;
      }
      .appd-explorer {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        width: 340px;
        box-shadow: 0 1px 1px hsl(0deg 0% 0% / 0.075),
          0 2px 2px hsl(0deg 0% 0% / 0.075), 0 4px 4px hsl(0deg 0% 0% / 0.075),
          0 8px 8px hsl(0deg 0% 0% / 0.075), 0 16px 16px hsl(0deg 0% 0% / 0.075);
        z-index: 1;
        display: flex;
      }
      .appd-preview {
        position: absolute;
        top: 0;
        left: 340px;
        right: 400px;
        bottom: 0;
        display: flex;
      }
      .appd-details {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 400px;
        box-shadow: 0 1px 1px hsl(0deg 0% 0% / 0.075),
          0 2px 2px hsl(0deg 0% 0% / 0.075), 0 4px 4px hsl(0deg 0% 0% / 0.075),
          0 8px 8px hsl(0deg 0% 0% / 0.075), 0 16px 16px hsl(0deg 0% 0% / 0.075);
        z-index: 1;
        display: flex;
        overflow-y: auto;
      }
      .appd.fullscreen .appd-explorer {
        left: -340px;
      }
      .appd.fullscreen .appd-details {
        right: -400px;
      }
      .appd.fullscreen .appd-preview {
        left: 0;
        right: 0;
      }
      .appm {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 100vh;
        height: -webkit-fill-available;
        overflow: hidden;
      }
      .appm-explorer {
        position: absolute;
        inset: 0;
        display: flex;
        transform: scale(0.9);
        transition: transform 0.3s ease-out;
      }
      .appm-explorer.visible {
        transform: scale(1);
      }
      .appm-shade {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease-out;
      }
      .appm-shade.visible {
        opacity: 1;
      }
      .appm-details {
        position: absolute;
        inset: 0;
        overflow-y: auto;
        background: white;
        transform: translateY(100%);
        border-radius: 20px;
        box-shadow: 0px -0.3px 0.3px hsl(var(--shadow-color) / 0.36),
          0px -1px 1.1px -0.8px hsl(var(--shadow-color) / 0.36),
          0px -2.5px 2.8px -1.7px hsl(var(--shadow-color) / 0.36),
          0px -6px 6.8px -2.5px hsl(var(--shadow-color) / 0.36);
        transition: all 0.3s ease-out;
        display: flex;
        flex-direction: column;
      }
      .appm-details.visible {
        transform: translateY(0%);
        border-radius: 0px;
      }
      .list {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .list-head {
        display: flex;
        align-items: center;
        padding: 16px 16px 10px;
      }
      .list-back {
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        width: 40px;
        height: 40px;
        margin-right: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .list-logo {
        width: 40px;
        height: 40px;
        margin-right: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .list-search {
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        padding: 0 8px;
        height: 40px;
        display: flex;
        align-items: center;
        flex: 1;
      }
      .list-search-icon {
        margin-right: 6px;
      }
      .list-search-input {
        flex: 1;
      }
      .list-search-clear {
        margin-left: 8px;
        cursor: pointer;
      }
      .list-random {
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        width: 40px;
        height: 40px;
        margin-left: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .list-body {
        flex: 1;
        position: relative;
        overflow: hidden;
      }
      .list-inner {
        position: absolute;
        inset: 0 12px;
      }
      .list-scroll {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .cell {
        display: flex;
        padding: 4px;
      }
      .cell-inner {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border: 1px solid transparent;
        border-radius: 10px;
      }
      .cell:hover:not(.selected) .cell-inner {
        cursor: pointer;
        border-color: rgba(0, 0, 0, 0.1);
      }
      .cell.selected .cell-inner {
        box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
        border-color: rgba(0, 0, 0, 0.1);
      }
      .cell-img {
        width: 64px;
        height: 64px;
        flex-shrink: 0;
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
      }
      .cell-info {
        flex: 1;
      }
      .cell-name {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 14px;
        width: 100%;
        text-align: center;
        padding: 0 8px;
      }
      .cell.collection .cell-img {
        width: 50px;
        height: 50px;
        margin: 0 0 5px;
        border-radius: 10px;
      }
      .preview {
        flex: 1;
        position: relative;
      }
      .preview-mv {
        width: 100%;
        height: 100%;
        transition: opacity 0.15s ease-out;
      }
      .preview-mv.loading {
        opacity: 0.3;
      }
      .preview-loading {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
      }
      .preview-fullscreen {
        position: absolute;
        top: 16px;
        right: 16px;
        box-shadow: 0px 0px 4px rgba(0, 0, 0, 0.15);
        border-radius: 20px;
        background: white;
        width: 40px;
        height: 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .details {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .details-head {
        display: flex;
        padding: 16px;
        position: sticky;
        top: 0px;
        z-index: 1;
        background: white;
        display: flex;
        align-items: center;
      }
      .details-head-side {
        width: 60px;
        display: flex;
      }
      .details-head-side.right {
        justify-content: flex-end;
      }
      .details-head-btn {
        width: 40px;
        height: 40px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .details-head-btn.close {
        cursor: pointer;
      }
      @media all and (min-width: 1000px) {
        .details-head-btn.close {
          display: none;
        }
      }
      .details-name {
        flex: 1;
        text-align: center;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }
      .details-external {
        margin-left: 8px;
      }
      .details-body {
        flex: 1;
        padding: 0 20px 20px;
      }
      .details-preview {
        height: 400px;
        border-radius: 10px;
        overflow: hidden;
        margin: 0 0 20px;
        display: flex;
      }
      .details-preview.fullscreen {
        position: absolute;
        inset: 0;
        height: inherit;
        margin: 0;
        z-index: 1;
        border-radius: 0;
      }
      .details-img {
        padding-bottom: 100%;
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        margin: 0 0 20px;
      }
      .details-name {
        font-size: 21px;
        font-weight: 600;
        line-height: 1.3;
      }
      .details-desc {
        line-height: 1.3;
        margin: 0 0 20px;
      }
      .details-attr {
        margin: 0 0 12px;
        display: flex;
      }
      .details-attr-name {
        font-weight: 600;
        line-height: 1;
        width: 100px;
        flex-shrink: 0;
      }
      .details-attr-value {
        word-break: break-all;
      }
      .details-attr-value.-link {
        color: #893aff;
        cursor: pointer;
      }
      .details-foot {
        display: flex;
        justify-content: center;
        background: white;
        padding: 16px;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        position: sticky;
        bottom: 0;
      }
      .details-foot-btn {
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        margin: 0 4px;
        cursor: pointer;
      }
      @media all and (min-width: 1000px) {
        .details-foot {
          display: none;
        }
      }
    </style>

    <!-- app -->

    <script type="text/babel" data-presets="env,react">
      const { useRef, useEffect, useLayoutEffect, useState, useMemo } = React;
      const { FixedSizeGrid } = window.ReactWindow;

      initCollections();
      initWearables();

      const collectionsById = {};
      for (const collection of db.collections) {
        collectionsById[collection.id] = collection;
      }

      const wearablesById = {};
      for (const wearable of db.wearables) {
        wearablesById[wearable.id] = wearable;
      }

      const url = new URL(window.location.href);
      const params = url.searchParams;

      let iCollectionQuery = "";
      if (params.get("cq")) {
        iCollectionQuery = params.get("cq");
      }
      let iCollection;
      if (params.get("cid")) {
        iCollection = getCollection(params.get("cid"));
      }
      let iWearableQuery = "";
      if (params.get("wq")) {
        iWearableQuery = params.get("wq");
      }
      let iWearable;
      if (params.get("wid")) {
        iWearable = getWearable(params.get("wid"));
      }

      ReactDOM.render(<App />, document.getElementById("root"));

      function App() {
        const [collectionQuery, setCollectionQuery] =
          useState(iCollectionQuery);
        const [collection, setCollection] = useState(iCollection);
        const [wearableQuery, setWearableQuery] = useState(iWearableQuery);
        let [wearable, setWearable] = useState(iWearable);
        const [mobile, setMobile] = useState(window.innerWidth <= 1000);
        const collections = useMemo(() => {
          return queryCollections(collectionQuery);
        }, [collectionQuery]);
        const wearables = useMemo(() => {
          return queryWearables(collection?.id, wearableQuery);
        }, [wearableQuery, collection?.id]);
        if (!wearable && !mobile) wearable = wearables[0];
        const [fullscreen, setFullscreen] = useState(false);
        useEffect(() => {
          const onResize = () => {
            setMobile(window.innerWidth <= 1000);
          };
          window.addEventListener("resize", onResize);
          return () => {
            window.removeEventListener("resize", onResize);
          };
        }, []);
        useEffect(() => {
          setParam("cid", collection?.id);
          setParam("cq", collectionQuery);
          setParam("wid", wearable?.id);
          setParam("wq", wearableQuery);
        }, [collection, collectionQuery, wearable, wearableQuery]);
        if (mobile) {
          return (
            <div className="appm">
              <div className={cls("appm-explorer", { visible: !wearable })}>
                {!collection && (
                  <CollectionExplorer
                    collectionQuery={collectionQuery}
                    setCollectionQuery={setCollectionQuery}
                    collections={collections}
                    setCollection={setCollection}
                    wearables={wearables}
                    setWearable={setWearable}
                  />
                )}
                {collection && (
                  <WearableExplorer
                    back={() => {
                      setWearableQuery("");
                      setCollection(null);
                    }}
                    wearableQuery={wearableQuery}
                    setWearableQuery={setWearableQuery}
                    wearables={wearables}
                    wearable={wearable}
                    setWearable={setWearable}
                    collection={collection}
                  />
                )}
              </div>
              <div className={cls("appm-shade", { visible: wearable })} />
              <div className={cls("appm-details", { visible: wearable })}>
                {wearable && (
                  <Details
                    wearable={wearable}
                    setWearableQuery={setWearableQuery}
                    setWearable={setWearable}
                    setCollection={setCollection}
                    isMobile
                    goPrevious={() => {
                      let idx = wearables.indexOf(wearable);
                      idx--;
                      if (idx < 0) return;
                      const nextWearable = wearables[idx];
                      setWearable(nextWearable);
                    }}
                    goRandom={() => {
                      const nextWearable = pickRandom(wearables);
                      setWearable(nextWearable);
                    }}
                    goNext={() => {
                      let idx = wearables.indexOf(wearable);
                      idx++;
                      if (idx > wearables.length - 1) return;
                      const nextWearable = wearables[idx];
                      setWearable(nextWearable);
                    }}
                  />
                )}
              </div>
            </div>
          );
        }

        return (
          <div className={cls("appd", { fullscreen })}>
            <div className="appd-explorer">
              {!collection && (
                <CollectionExplorer
                  collectionQuery={collectionQuery}
                  setCollectionQuery={setCollectionQuery}
                  collections={collections}
                  collection={collection}
                  setCollection={setCollection}
                  wearables={wearables}
                  setWearable={setWearable}
                />
              )}
              {collection && (
                <WearableExplorer
                  back={() => {
                    setWearableQuery("");
                    setCollection(null);
                  }}
                  wearableQuery={wearableQuery}
                  setWearableQuery={setWearableQuery}
                  wearables={wearables}
                  wearable={wearable}
                  setWearable={setWearable}
                  collection={collection}
                />
              )}
            </div>
            <div className="appd-preview">
              {wearable && (
                <Preview
                  wearable={wearable}
                  fullscreen={fullscreen}
                  setFullscreen={setFullscreen}
                />
              )}
            </div>
            <div className="appd-details">
              <Details
                wearable={wearable}
                setWearableQuery={setWearableQuery}
                setWearable={setWearable}
                setCollection={setCollection}
              />
            </div>
          </div>
        );
      }

      let collectionScrollTop = 0;
      function CollectionExplorer({
        collectionQuery,
        setCollectionQuery,
        collections,
        collection,
        setCollection,
        wearables,
        setWearable,
      }) {
        const innerRef = useRef();
        const listRef = useRef();
        const size = useSize(innerRef);
        const numColumns = Math.round(size[0] / 100);
        const cellSize = size[0] / numColumns;
        useEffect(() => {
          if (!size[0]) return;
          const list = listRef.current;
          list.scrollTo({ scrollTop: collectionScrollTop });
          return () => {
            collectionScrollTop = list.state.scrollTop;
          };
        }, [size]);
        // useEffect(() => {
        //   if (!size[0]) return;
        //   const list = listRef.current;
        //   list.scrollTo({ scrollTop: 0 });
        // }, [collectionQuery]);
        return (
          <div className="list">
            <div className="list-head">
              <div className="list-logo">
                <Logo size={38} />
              </div>
              <label className="list-search">
                <SearchIcon className="list-search-icon" size={18} />
                <input
                  className="list-search-input"
                  placeholder="Search collections"
                  type="text"
                  value={collectionQuery}
                  onChange={(e) => {
                    const value = e.target.value;
                    setCollectionQuery(value);
                    setParam("cq", value);
                  }}
                />
                {collectionQuery && (
                  <ClearIcon
                    className="list-search-clear"
                    size={20}
                    onClick={() => {
                      setCollectionQuery("");
                      setParam("cq", null);
                    }}
                  />
                )}
              </label>
              <div
                className="list-random"
                onClick={() => {
                  const wearable = pickRandom(wearables);
                  setWearable(wearable);
                  setCollection(getCollection("*"));
                }}
              >
                <DiceIcon size={20} />
              </div>
            </div>
            <div className="list-body">
              <div className="list-inner" ref={innerRef}>
                <FixedSizeGrid
                  className="list-scroll"
                  ref={listRef}
                  width={size[0]}
                  height={size[1]}
                  columnCount={numColumns}
                  columnWidth={size[0] / numColumns}
                  rowCount={Math.ceil(collections.length / numColumns)}
                  rowHeight={size[0] / numColumns}
                >
                  {({ columnIndex, rowIndex, style }) => {
                    const idx = rowIndex * numColumns + columnIndex;
                    const collection = collections[idx];
                    if (!collection) return null;
                    return (
                      <CollectionCell
                        style={style}
                        collection={collection}
                        onClick={() => setCollection(collection)}
                      />
                    );
                    return (
                      <div
                        style={style}
                        onClick={() => setCollection(collection)}
                      >
                        {collection.name}
                      </div>
                    );
                  }}
                </FixedSizeGrid>
              </div>
            </div>
          </div>
        );
      }

      function WearableExplorer({
        back,
        wearableQuery,
        setWearableQuery,
        wearables,
        wearable,
        setWearable,
        collection,
      }) {
        const innerRef = useRef();
        const listRef = useRef();
        const size = useSize(innerRef);
        const numColumns = Math.round(size[0] / 100);
        const cellSize = size[0] / numColumns;
        useEffect(() => {
          if (!size[0]) return;
          if (!wearable) return;
          const idx = wearables.indexOf(wearable);
          const rowIndex = Math.floor(idx / numColumns);
          const columnIndex = idx % numColumns;
          listRef.current.scrollToItem({
            align: "start",
            rowIndex,
            columnIndex,
          });
        }, [size]);
        return (
          <div className="list">
            <div className="list-head">
              <div className="list-back" onClick={back}>
                <LeftIcon size={18} />
              </div>
              <label className="list-search">
                <SearchIcon className="list-search-icon" size={18} />
                <input
                  className="list-search-input"
                  placeholder={`Search ${collection.name}`}
                  type="text"
                  value={wearableQuery}
                  onChange={(e) => {
                    const value = e.target.value;
                    setWearableQuery(value);
                    setParam("wq", value);
                  }}
                />
                {wearableQuery && (
                  <ClearIcon
                    className="list-search-clear"
                    size={20}
                    onClick={() => {
                      setWearableQuery("");
                      setParam("wq", null);
                    }}
                  />
                )}
              </label>
              <div
                className="list-random"
                onClick={(e) => {
                  e.preventDefault();
                  const wearable = pickRandom(wearables);
                  setWearable(wearable);
                  setParam("id", wearable.id);
                  const idx = wearables.indexOf(wearable);
                  const rowIndex = Math.floor(idx / numColumns);
                  const columnIndex = idx % numColumns;
                  listRef.current.scrollToItem({
                    align: "start",
                    rowIndex,
                    columnIndex,
                  });
                }}
              >
                <DiceIcon size={20} />
              </div>
            </div>
            <div className="list-body">
              <div className="list-inner" ref={innerRef}>
                <FixedSizeGrid
                  className="list-scroll"
                  ref={listRef}
                  width={size[0]}
                  height={size[1]}
                  columnCount={numColumns}
                  columnWidth={size[0] / numColumns}
                  rowCount={Math.ceil(wearables.length / numColumns)}
                  rowHeight={size[0] / numColumns}
                >
                  {({ columnIndex, rowIndex, style }) => {
                    const idx = rowIndex * numColumns + columnIndex;
                    const _wearable = wearables[idx];
                    if (!_wearable) return null;
                    return (
                      <WearableCell
                        style={style}
                        wearable={_wearable}
                        selected={wearable === _wearable}
                        onClick={() => {
                          setWearable(_wearable);
                          setParam("wid", _wearable.id);
                        }}
                      />
                    );
                  }}
                </FixedSizeGrid>
              </div>
            </div>
          </div>
        );
      }

      const imgLoaded = new Set();

      function CollectionCell({ collection, style, onClick }) {
        const imgRef = useRef();
        useEffect(() => {
          const elem = imgRef.current;
          const url = `url(${collection.image})`;
          const loaded = imgLoaded.has(url);
          if (loaded) {
            elem.style.backgroundImage = url;
            return;
          }
          let dead;
          setTimeout(() => {
            if (dead) return;
            elem.style.backgroundImage = url;
            imgLoaded.add(url);
          }, 300);
          return () => {
            dead = true;
          };
        }, []);
        return (
          <div className={"cell collection"} style={style} onClick={onClick}>
            <div className="cell-inner">
              <div className="cell-img" ref={imgRef} />
              <div className="cell-name">{collection.name}</div>
            </div>
          </div>
        );
      }

      function WearableCell({ wearable, selected, style, onClick }) {
        const imgRef = useRef();
        useEffect(() => {
          const elem = imgRef.current;
          const url = `url(${wearable.image})`;
          const loaded = imgLoaded.has(url);
          if (loaded) {
            elem.style.backgroundImage = url;
            return;
          }
          let dead;
          setTimeout(() => {
            if (dead) return;
            elem.style.backgroundImage = url;
            imgLoaded.add(url);
          }, 300);
          return () => {
            dead = true;
          };
        }, []);
        return (
          <div
            className={cls("cell", { selected })}
            style={style}
            onClick={onClick}
          >
            <div className="cell-inner">
              <div className="cell-img" ref={imgRef} />
              <div className="cell-name">{wearable.name}</div>
            </div>
          </div>
        );
      }

      function Preview({ wearable, fullscreen, setFullscreen }) {
        const mvRef = useRef();
        const [loading, setLoading] = useState(true);
        useEffect(() => {
          const viewer = mvRef.current;
          viewer.addEventListener("load", () => {
            setLoading(false);
          });
        }, []);
        useEffect(() => {
          setLoading(true);
        }, [wearable]);
        return (
          <div className="preview">
            <model-viewer
              id={"mv"}
              ref={mvRef}
              src={wearable.glb}
              class={cls("preview-mv", { loading })}
              camera-controls
              tone-mapping="commerce"
              exposure="1.2"
              ar
              xr-environment
              shadow-intensity="1"
              shadow-softness="1"
              skybox-image={`https://arweave.net/ataPSsAKl_22yZYVEZVFdOk2vpFw6O2ffyrmYVxIXLs/${wearable.year}.jpg`}
              skybox-height="1.4m"
            >
              <div slot="progress-bar" />
            </model-viewer>
            {loading && (
              <div className="preview-loading">
                <Spinner />
              </div>
            )}
            <div
              className="preview-fullscreen"
              onClick={() => setFullscreen(!fullscreen)}
            >
              {!fullscreen && <MaximizeIcon size={20} />}
              {fullscreen && <MinimizeIcon size={20} />}
            </div>
          </div>
        );
      }

      function Details({
        wearable,
        setWearable,
        setWearableQuery,
        setCollection,
        isMobile,
        goPrevious,
        goRandom,
        goNext,
      }) {
        const [fullscreen, setFullscreen] = useState(false);
        // if (!wearable) return null; // TODO: fix
        const collection = getCollection(wearable.collectionId);
        const download = async (url, fileName) => {
          const resp = await fetch(url);
          const blob = await resp.blob();
          const link = document.createElement("a");
          const localUrl = URL.createObjectURL(blob);
          link.setAttribute("href", localUrl);
          link.setAttribute("download", fileName);
          link.style.visibility = "hidden";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };
        return (
          <div className="details">
            <div className="details-head">
              <div className="details-head-side left"></div>
              <div className="details-name">{wearable.name}</div>
              <div className="details-head-side right">
                <div
                  className="details-head-btn close"
                  onClick={() => setWearable(null)}
                >
                  <CloseIcon size={20} />
                </div>
              </div>
            </div>
            <div className="details-body">
              {isMobile && (
                <div className={cls("details-preview", { fullscreen })}>
                  <Preview
                    wearable={wearable}
                    fullscreen={fullscreen}
                    setFullscreen={setFullscreen}
                  />
                </div>
              )}
              {!isMobile && (
                <div
                  className="details-img"
                  style={{ backgroundImage: `url(${wearable.image})` }}
                />
              )}
              <div className="details-desc">{wearable.description}</div>
              <div className="details-attr">
                <div className="details-attr-name">Token</div>
                <div className="details-attr-value">{wearable.tokenId}</div>
              </div>
              <div className="details-attr">
                <div className="details-attr-name">Collection</div>
                <div
                  className="details-attr-value -link"
                  onClick={() => {
                    setWearableQuery(`collection:${collection.id}`);
                    setCollection(getCollection("*"));
                    if (isMobile) setWearable(null);
                  }}
                >
                  {collection.id} ({collection.name})
                </div>
              </div>
              <div className="details-attr">
                <div className="details-attr-name">Author</div>
                <div
                  className="details-attr-value -link"
                  onClick={() => {
                    setWearableQuery(`author:"${wearable.author}"`);
                    setCollection(getCollection("*"));
                    if (isMobile) setWearable(null);
                  }}
                >
                  {wearable.author}
                </div>
              </div>
              <div className="details-attr">
                <div className="details-attr-name">Rarity</div>
                <div
                  className="details-attr-value -link"
                  onClick={() => {
                    setWearableQuery(`rarity:${wearable.rarity}`);
                    setCollection(getCollection("*"));
                    if (isMobile) setWearable(null);
                  }}
                >
                  {wearable.rarity}
                </div>
              </div>
              <div className="details-attr">
                <div className="details-attr-name">Issues</div>
                <div
                  className="details-attr-value -link"
                  onClick={() => {
                    setWearableQuery(`issues:${wearable.issues}`);
                    setCollection(getCollection("*"));
                    if (isMobile) setWearable(null);
                  }}
                >
                  {wearable.issues}
                </div>
              </div>
              <div className="details-attr">
                <div className="details-attr-name">Year</div>
                <div
                  className="details-attr-value -link"
                  onClick={() => {
                    setWearableQuery(`year:${wearable.year}`);
                    setCollection(getCollection("*"));
                    if (isMobile) setWearable(null);
                  }}
                >
                  {wearable.year}
                </div>
              </div>
              <div className="details-attr">
                <div className="details-attr-name">GLB</div>
                <div
                  className="details-attr-value -link"
                  onClick={() => {
                    download(
                      wearable.glb,
                      `voxels-wearable-${wearable.collectionId}-${wearable.tokenId}.glb`
                    );
                  }}
                >
                  <span>Download</span>
                </div>
              </div>
              <div className="details-attr">
                <div className="details-attr-name">VOX</div>
                <div
                  className="details-attr-value -link"
                  onClick={() => {
                    download(
                      wearable.vox,
                      `voxels-wearable-${wearable.collectionId}-${wearable.tokenId}.vox`
                    );
                  }}
                >
                  <span>Download</span>
                </div>
              </div>
              <div className="details-attr">
                <div className="details-attr-name">SVOX</div>
                <div
                  className="details-attr-value -link"
                  onClick={() => {
                    download(
                      wearable.svox,
                      `voxels-wearable-${wearable.collectionId}-${wearable.tokenId}.svox`
                    );
                  }}
                >
                  <span>Download</span>
                </div>
              </div>
            </div>
            <div className="details-foot">
              <div
                className="details-foot-btn"
                onClick={() => {
                  goPrevious();
                }}
              >
                <LeftIcon />
              </div>
              <div className="details-foot-btn" onClick={goRandom}>
                <DiceIcon />
              </div>
              <div className="details-foot-btn" onClick={goNext}>
                <RightIcon />
              </div>
            </div>
          </div>
        );
      }

      function SearchIcon({ size = 24, ...props }) {
        return (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width={size}
            height={size}
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            {...props}
          >
            <circle cx="11" cy="11" r="8" />
            <path d="m21 21-4.3-4.3" />
          </svg>
        );
      }

      function DiceIcon({ size = 24, ...props }) {
        return (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width={size}
            height={size}
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            {...props}
          >
            <rect width="12" height="12" x="2" y="10" rx="2" ry="2" />
            <path d="m17.92 14 3.5-3.5a2.24 2.24 0 0 0 0-3l-5-4.92a2.24 2.24 0 0 0-3 0L10 6" />
            <path d="M6 18h.01" />
            <path d="M10 14h.01" />
            <path d="M15 6h.01" />
            <path d="M18 9h.01" />
          </svg>
        );
      }

      function ClearIcon({ size = 24, ...props }) {
        return (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width={size}
            height={size}
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            {...props}
          >
            <circle cx="12" cy="12" r="10" />
            <path d="m15 9-6 6" />
            <path d="m9 9 6 6" />
          </svg>
        );
      }

      function ExternalIcon({ size = 24, ...props }) {
        return (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width={size}
            height={size}
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h6" />
            <path d="m21 3-9 9" />
            <path d="M15 3h6v6" />
          </svg>
        );
      }

      function CloseIcon({ size = 24, ...props }) {
        return (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width={size}
            height={size}
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M18 6 6 18" />
            <path d="m6 6 12 12" />
          </svg>
        );
      }

      function LeftIcon({ size = 24, ...props }) {
        return (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width={size}
            height={size}
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="m12 19-7-7 7-7" />
            <path d="M19 12H5" />
          </svg>
        );
      }

      function RightIcon({ size = 24, ...props }) {
        return (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width={size}
            height={size}
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M5 12h14" />
            <path d="m12 5 7 7-7 7" />
          </svg>
        );
      }

      function MaximizeIcon({ size = 24, ...props }) {
        return (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width={size}
            height={size}
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M8 3H5a2 2 0 0 0-2 2v3" />
            <path d="M21 8V5a2 2 0 0 0-2-2h-3" />
            <path d="M3 16v3a2 2 0 0 0 2 2h3" />
            <path d="M16 21h3a2 2 0 0 0 2-2v-3" />
          </svg>
        );
      }

      function MinimizeIcon({ size = 24, ...props }) {
        return (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width={size}
            height={size}
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-minimize"
          >
            <path d="M8 3v3a2 2 0 0 1-2 2H3" />
            <path d="M21 8h-3a2 2 0 0 1-2-2V3" />
            <path d="M3 16h3a2 2 0 0 1 2 2v3" />
            <path d="M16 21v-3a2 2 0 0 1 2-2h3" />
          </svg>
        );
      }

      function Logo({ size = 24, ...props }) {
        return (
          <svg
            width={size}
            height={size}
            viewBox="0 0 137 137"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path d="M0 14.2H27.4V41.6H0V14.2Z" fill="#E94420" />
            <path d="M0 41.6H27.4V69H0V41.6Z" fill="#E9AE20" />
            <path d="M0 69H27.4V96.3999H0V69Z" fill="#B1E920" />
            <path d="M109.6 14.2H137V41.6H109.6V14.2Z" fill="#E94420" />
            <path d="M109.6 41.6H137V69H109.6V41.6Z" fill="#E9AE20" />
            <path d="M109.6 69H137V96.3999H109.6V69Z" fill="#B1E920" />
            <path
              d="M27.4 96.3999L54.8 96.3997V123.8H27.4V96.3999Z"
              fill="#20E9AC"
            />
            <path
              d="M82.2 96.3997L109.6 96.3999V123.8H82.2V96.3997Z"
              fill="#20E9AC"
            />
            <path d="M54.8 69H82.2V96.3997H54.8V69Z" fill="#2091E9" />
            <path d="M54.8 41.6H82.2V69H54.8V41.6Z" fill="#C420E9" />
            <path d="M54.8 14.2H82.2V41.6H54.8V14.2Z" fill="#E92071" />
          </svg>
        );
        // return (
        //   <svg
        //     width={size}
        //     height={size}
        //     viewBox="0 0 137 137"
        //     fill="none"
        //     xmlns="http://www.w3.org/2000/svg"
        //   >
        //     <g clip-path="url(#clip0_6_179)">
        //       <path
        //         d="M63 3.4641C66.7128 1.32051 71.2872 1.32051 75 3.4641L122.756 31.0359C126.469 33.1795 128.756 37.141 128.756 41.4282V96.5718C128.756 100.859 126.469 104.821 122.756 106.964L75 134.536C71.2872 136.679 66.7128 136.679 63 134.536L15.2443 106.964C11.5314 104.821 9.24426 100.859 9.24426 96.5718V41.4282C9.24426 37.141 11.5314 33.1795 15.2443 31.0359L63 3.4641Z"
        //         fill="url(#paint0_linear_6_179)"
        //       />
        //       <path d="M31 39H46V54H31V39Z" fill="#E94420" />
        //       <path d="M31 54H46V69H31L31 54Z" fill="#E9AE20" />
        //       <path d="M31 69H46V84H31V69Z" fill="#B1E920" />
        //       <path d="M91 39H106V54H91V39Z" fill="#E94420" />
        //       <path d="M91 54H106V69H91V54Z" fill="#E9AE20" />
        //       <path d="M91 69H106V84H91V69Z" fill="#B1E920" />
        //       <path d="M46 84L61 83.9999V98.9999H46V84Z" fill="#20E9AC" />
        //       <path d="M76 83.9999L91 84V98.9999H76V83.9999Z" fill="#20E9AC" />
        //       <path d="M61 69H76V83.9999H61V69Z" fill="#2091E9" />
        //       <path d="M61 54H76V69H61V54Z" fill="#C420E9" />
        //       <path d="M61 39H76V54H61V39Z" fill="#E92071" />
        //     </g>
        //     <defs>
        //       <linearGradient
        //         id="paint0_linear_6_179"
        //         x1="69"
        //         y1="0"
        //         x2="69"
        //         y2="138"
        //         gradientUnits="userSpaceOnUse"
        //       >
        //         <stop stop-color="#6E2878" />
        //         <stop offset="1" stop-color="#37184F" />
        //       </linearGradient>
        //       <clipPath id="clip0_6_179">
        //         <rect width="137" height="137" fill="white" />
        //       </clipPath>
        //     </defs>
        //   </svg>
        // );
      }

      function CollectionsIcon({ size = 24, ...props }) {
        return (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width={size}
            height={size}
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-component"
          >
            <path d="M5.5 8.5 9 12l-3.5 3.5L2 12l3.5-3.5Z" />
            <path d="m12 2 3.5 3.5L12 9 8.5 5.5 12 2Z" />
            <path d="M18.5 8.5 22 12l-3.5 3.5L15 12l3.5-3.5Z" />
            <path d="m12 15 3.5 3.5L12 22l-3.5-3.5L12 15Z" />
          </svg>
        );
      }

      function Spinner() {
        return <span class="spinner"></span>;
      }

      // let imgs;
      // function getImg(url, spawn = true) {
      //   if (!imgs) imgs = new Map();
      //   let img = imgs.get(url);
      //   if (!img && spawn) {
      //     img = document.createElement("img");
      //     img.src = url;
      //     imgs.set(url, img);
      //   }
      //   return img;
      // }

      function pickRandom(array) {
        return array[Math.floor(Math.random() * array.length)];
      }

      function getWearable(id) {
        return wearablesById[id];
      }

      function getCollection(id) {
        return collectionsById[id];
      }

      function cls(...args) {
        let str = "";
        for (const arg of args) {
          if (typeof arg === "string") {
            str += " " + arg;
          } else if (typeof arg === "object") {
            for (const key in arg) {
              const value = arg[key];
              if (value) str += " " + key;
            }
          }
        }
        return str;
      }

      function useSize(elemRef) {
        const [size, setSize] = useState([0, 0]);
        useLayoutEffect(() => {
          const elem = elemRef.current;
          const onResize = () => {
            setSize([elem.offsetWidth, elem.offsetHeight]);
          };
          const resizer = new ResizeObserver(() => {
            onResize();
          });
          resizer.observe(elemRef.current);
          onResize();
        }, []);
        return size;
      }

      function setParam(key, value) {
        const url = new URL(window.location.href);
        if (value) {
          url.searchParams.set(key, value);
        } else {
          url.searchParams.delete(key);
        }
        history.replaceState(null, "", url.toString());
      }

      function parseWearablesQuery(query) {
        const matchers = [];
        const regex = /(\w+:"[^"]+"|\w+:\S+|\S+)/g;
        let match;
        while ((match = regex.exec(query)) !== null) {
          const part = match[0];
          const nameValueMatch = part.match(/(\w+):("[^"]+"|\S+)/);
          if (nameValueMatch) {
            const name = nameValueMatch[1];
            let value = nameValueMatch[2];
            if (value.startsWith('"') && value.endsWith('"')) {
              value = value.slice(1, -1); // Remove the surrounding quotes
            }
            matchers.push({ name, value, exact: true });
          } else {
            matchers.push({
              name: "any",
              value: part.toLowerCase(),
              exact: false,
            });
          }
        }
        return matchers;
      }

      function queryWearables(collectionId, query) {
        const matcherNamesToKey = {
          any: "keywords",
          issues: "issues",
          year: "year",
          author: "author",
          rarity: "rarity",
          collection: "collectionId",
          token: "tokenId",
        };
        const matchers = query ? parseWearablesQuery(query) : null;
        return db.wearables.filter((wearable) => {
          if (
            collectionId &&
            collectionId !== "*" &&
            wearable.collectionId !== collectionId
          ) {
            return false;
          }
          if (!matchers) {
            return true;
          }
          for (const matcher of matchers) {
            const key = matcherNamesToKey[matcher.name];
            if (!key) return false;
            if (matcher.exact) {
              if (wearable[key] !== matcher.value) {
                return false;
              }
            } else {
              if (!wearable[key].includes(matcher.value)) {
                return false;
              }
            }
          }
          return true;
        });
      }

      function queryCollections(query) {
        if (!query) return db.collections;
        query = query.toLowerCase();
        const results = db.collections.filter((collection) => {
          return collection.keywords.includes(query);
        });
        return results;
      }

      function initCollections() {
        // add "all" collection
        db.collections.unshift({
          id: "*",
          name: "All Collections",
          image: null,
        });
        // build keywords
        const keywordKeys = ["name"];
        for (const collection of db.collections) {
          const keywords = [];
          for (const key of keywordKeys) {
            keywords.push(collection[key]);
          }
          collection.keywords = keywords.join(" ").toLowerCase();
        }
        // build images
        for (const collection of db.collections) {
          if (collection.hasImage) {
            collection.image = `https://arweave.net/YgdXdtgECPF5wcOpVgKVHqgYTVdayKGdq-KQoQS7LqY/${collection.id}.png`;
          }
        }
      }

      function initWearables() {
        const keywordKeys = [
          "name",
          "image",
          "description",
          "rarity",
          "year",
          "author",
          "tokenId",
          "collectionId",
          "collectionName",
        ];
        for (const wearable of db.wearables) {
          const keywords = [];
          for (const key of keywordKeys) {
            keywords.push(wearable[key]);
          }
          wearable.keywords = keywords.join(" ").toLowerCase();
        }
      }
    </script>

    <!-- micro css-reset -->

    <style>
      html {
        box-sizing: border-box;
        font-size: 16px;
      }

      *,
      *:before,
      *:after {
        box-sizing: inherit;
      }

      body,
      h1,
      h2,
      h3,
      h4,
      h5,
      h6,
      p,
      ol,
      ul {
        margin: 0;
        padding: 0;
        font-weight: normal;
      }

      ol,
      ul {
        list-style: none;
      }

      img {
        max-width: 100%;
        height: auto;
      }
    </style>

    <!-- spinner styles -->

    <style>
      .spinner {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: inline-block;
        position: relative;
        border: 3px solid;
        border-color: #fff #fff transparent transparent;
        box-sizing: border-box;
        animation: rotation 1s linear infinite;
      }
      .spinner::after,
      .spinner::before {
        content: "";
        box-sizing: border-box;
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        margin: auto;
        border: 3px solid;
        border-color: transparent transparent #b700ff #d000ff;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        box-sizing: border-box;
        animation: rotationBack 0.5s linear infinite;
        transform-origin: center center;
      }
      .spinner::before {
        width: 32px;
        height: 32px;
        border-color: #fff #fff transparent transparent;
        animation: rotation 1.5s linear infinite;
      }
      @keyframes rotation {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      @keyframes rotationBack {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(-360deg);
        }
      }
    </style>
  </body>
</html>
